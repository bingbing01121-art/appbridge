<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AppBridgeH5 SDK æ¼”ç¤º</title>

    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet"/>
    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>

    <script>
        let currentDownloadTaskId = null; // To store the actual task ID from FlutterDownloader
        let isNavBarsVisible = true; // Track current visibility state
        let isCustomTitleSet = false; // Track if custom title is set
        let lastDownloadedApkPath = null; // Store the path of the last downloaded APK
        let player; // Declare player globally
        let wasPausedByNavigation = false; // Flag for pause/resume on navigation

        // Pause/Resume video on navigation
        window.addEventListener('app.pause', () => {
            if (player && !player.paused()) {
                player.pause();
                wasPausedByNavigation = true;
                console.log('Player paused due to navigation.');
            }
        });

        window.addEventListener('app.resume', () => {
            if (player && wasPausedByNavigation) {
                player.play();
                wasPausedByNavigation = false;
                console.log('Player resumed on return to page.');
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            player = videojs('m3u8VideoPlayer');
            player.on('play', () => {
                console.log('Playback started. Waiting 1 second to unmute.');
                setTimeout(() => {
                    if (player) {
                        console.log('Attempting to unmute player.');
                        player.muted(false);
                    }
                }, 1000);
            });
        });



    </script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin: 25px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }
        .section h2 {
            color: #007AFF;
            margin-top: 0;
        }
        .button {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px;
            font-size: 14px;
            transition: background 0.2s;
        }
        .button:hover {
            background: #0056CC;
        }
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            font-family: 'Monaco', 'Menlo', monospace;
            white-space: pre-wrap;
            border-left: 4px solid #007AFF;
            font-size: 13px;
        }
        .error {
            border-left-color: #ff3b30;
            background: #fff5f5;
        }
        .success {
            border-left-color: #34c759;
            background: #f0fff4;
        }
        .status {
            text-align: center;
            padding: 20px;
            background: #e3f2fd;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
        }
        .status.error {
            background: #ffebee;
            color: #c62828;
        }



    </style>
</head>
<body>
<script>
       window.addEventListener('download_resumed', (event) => {
       const resumedId = event.detail.id;
       const newStatus = event.detail.status; // 'enqueued' or 'running'
       console.log(`Download with ID ${resumedId} was resumed. New status:
          ${newStatus}.`);
          // é€šè¿‡ ID åœ¨ web ç«¯åˆ—è¡¨ä¸­æ‰¾åˆ°ä¸‹è½½ä»»åŠ¡å¹¶æ›´æ–°å…¶çŠ¶æ€ã€‚
           const downloadItem = document.getElementById(`download-item-${resumedId}`
          );
       if (downloadItem) {
         // æ›´æ–°æ­¤é¡¹çš„çŠ¶æ€æ˜¾ç¤º
        const statusElement = downloadItem.querySelector('.download-status');
        if (statusElement) {
          statusElement.textContent = newStatus;
            }
          }
        });

       window.addEventListener('download_progress', (event) => {
       const downloadId = event.detail.id;
       const status = event.detail.status; // ä¾‹å¦‚ï¼Œ'running', 'paused','complete', 'failed', 'canceled'
       const progress = event.detail.progress; // 0-100

       console.log(`Download ID: ${downloadId}, Status: ${status}, Progress:${progress}%`);
       const downloadItem = document.getElementById(`download-item-${downloadId}`);

      if (downloadItem) {
        // æ›´æ–°è¿›åº¦æ¡
        const progressBar = downloadItem.querySelector('.progress-bar');
        if (progressBar) {
          progressBar.style.width = `${progress}%`;
          progressBar.textContent = `${progress}%`;
        }
        const statusElement = downloadItem.querySelector('.download-status');
        if (statusElement) {
          statusElement.textContent = status;
        }
        if (status === 'complete') {
          // éšè—æš‚åœ/æ¢å¤/å–æ¶ˆæŒ‰é’®ï¼Œæ˜¾ç¤ºâ€œæ‰“å¼€â€æŒ‰é’®
        } else if (status === 'failed' || status === 'canceled') {
          // æ˜¾ç¤ºâ€œé‡è¯•â€æŒ‰é’®ï¼Œéšè—è¿›åº¦
        }
      }
    });

        window.addEventListener('download.failed', (event) => {
            console.log('Received download.failed event directly on window:', event.detail);
            const data = event.detail;
            const downloadId = data.id;
            const progressContainer = document.getElementById(`apk-progress-container-${downloadId}`);
            if (progressContainer) {
                const progressText = document.getElementById(`apk-progress-text-${downloadId}`);
                progressText.innerText = 'å¤±è´¥!';
                progressContainer.classList.add('error');
                setTimeout(() => progressContainer.remove(), 5000);
            }
        });

        window.addEventListener('download.completed', (event) => {
            console.log('Received download.completed event directly on window:', event.detail);
            const data = event.detail;
            const downloadId = data.id;
            const progressContainer = document.getElementById(`apk-progress-container-${downloadId}`);
            if (progressContainer) {
                const progressText = document.getElementById(`apk-progress-text-${downloadId}`);
                const progressBar = document.getElementById(`apk-progress-bar-${downloadId}`);
                progressText.innerText = 'å®Œæˆ!';
                progressBar.value = 100;
                setTimeout(() => progressContainer.remove(), 3000);
            }
        });

        window.addEventListener('download.canceled', (event) => {
            console.log('Received download.canceled event directly on window:', event.detail);
            const data = event.detail;
            const canceledId = event.detail.id;
            const downloadId = data.id;
               const downloadItem = document.getElementById(`download-item-${canceledId}`);
                if (downloadItem) {
                downloadItem.remove();
                }
            const progressContainer = document.getElementById(`apk-progress-container-${downloadId}`);
            if (progressContainer) {
                const progressText = document.getElementById(`apk-progress-text-${downloadId}`);
                progressText.innerText = 'å·²å–æ¶ˆ';
                setTimeout(() => progressContainer.remove(), 3000);
            }
        });

        window.addEventListener('m3u8_download_progress', function(event) {
            console.log('M3U8 Download Progress:', event.detail);
            const data = event.detail;
            const downloadId = data.id;
            const el=document.getElementById('downloadResult');

            if (!downloadId) {
                console.error('M3U8 progress event is missing a download ID.');
                return;
            }

            const progressBar = document.getElementById(`m3u8-progress-bar-${downloadId}`);
            const progressText = document.getElementById(`m3u8-progress-text-${downloadId}`);
            const progressContainer = document.getElementById(`m3u8-progress-container-${downloadId}`);

            if (!progressBar || !progressText || !progressContainer) {
                // Progress bar might have been removed already (e.g., on completion/failure)
                return;
            }

            if (data.status === 'downloading') {
                if (data.progress) {
                    progressBar.value = data.progress;
                    progressText.innerText = `${data.progress}%`;
                } else if (data.processed_time) {
                    progressText.innerText = `å·²å¤„ç† ${Math.round(data.processed_time / 1000)} ç§’`;
                }
            } else if (data.status === 'completed') {
                progressText.innerText = 'å®Œæˆ!';
                progressBar.value = 100;
                el.innerHTML = `M3U8 ä¸‹è½½åˆå¹¶æˆåŠŸï¼æœ¬åœ°è·¯å¾„: ${data.path}`;
                el.className = 'result success';
                // Optionally remove the progress bar after a short delay
                setTimeout(() => progressContainer.remove(), 3000);
            } else if (data.status === 'failed') {
                progressText.innerText = `å¤±è´¥: ${data.error}`;
                progressContainer.classList.add('error');
                el.innerHTML = `M3U8 ä¸‹è½½åˆå¹¶å¤±è´¥: ${data.error}`;
                el.className = 'result error';
                // Optionally remove the progress bar after a short delay
                setTimeout(() => progressContainer.remove(), 5000);
            }
        });

        window.addEventListener('download.progress', (event) => {
            console.log('Received download.progress event directly on window:', event.detail);
            const data = event.detail;
            const downloadId = data.id;
            const progressBar = document.getElementById(`apk-progress-bar-${downloadId}`);
            const progressText = document.getElementById(`apk-progress-text-${downloadId}`);

            if (progressBar && progressText) {
                progressBar.value = data.progress;
                progressText.innerText = `${data.progress}% (${data.speed})`;
            }
        });

        // Global listener for any M3U8 download completion
        window.addEventListener('m3u8_download_progress', function(event) {
            const data = event.detail;
            if (data.status === 'completed') {
                console.log(`Global listener: M3U8 download completed for id ${data.id}. Updating player.`);
                const el = document.getElementById('downloadResult');
                if (player) {
                    player.src({ type: 'application/x-mpegURL', src: data.path });
                }
                el.innerHTML = `è§†é¢‘ä¸‹è½½å®Œæˆï¼Œå·²åŠ è½½æœ¬åœ°æ–‡ä»¶: ${data.path}`;
                el.className = 'result success';
            }
        });



</script>
<div class="container">
    <h1>ğŸš€ AppBridgeH5 SDK æ¼”ç¤º</h1>

    <div id="status" class="status">
        <div>æ­£åœ¨åˆå§‹åŒ– SDK...</div>
    </div>

    <div class="section">
        <h2>1. æ ¸å¿ƒåŠŸèƒ½</h2>
        <button class="button" onclick="checkInit()">æ£€æŸ¥åˆå§‹åŒ–çŠ¶æ€</button>
        <button class="button" onclick="getVersion()">è·å–ç‰ˆæœ¬ä¿¡æ¯</button>
        <button class="button" onclick="getCapabilities()">è·å–å¯ç”¨åŠŸèƒ½</button>
        <button class="button" onclick="getEnv()">è·å–ç¯å¢ƒä¿¡æ¯</button>
        <button class="button" onclick="hasMethod()">æ¢æµ‹æ–¹æ³•æ˜¯å¦å­˜åœ¨</button>
        <button class="button" onclick="vpnOn()">å¼€å¯VPN(ç¤ºä¾‹)</button>
        <button class="button" onclick="vpnOff()">å…³é—­VPN</button>
        <button class="button" onclick="addShortcut()">æ·»åŠ å¿«æ·æ–¹å¼</button>
        <button class="button" onclick="switchAppIcon()">åˆ‡æ¢å›¾æ ‡(ç¤ºä¾‹)</button>

        <div id="coreResult" class="result"></div>
    </div>

    <div class="section">
        <h2>2. äº‹ä»¶ç³»ç»Ÿ</h2>
        <button class="button" onclick="startEventListen()">å¼€å§‹ç›‘å¬äº‹ä»¶</button>
        <button class="button" onclick="stopEventListen()">åœæ­¢ç›‘å¬äº‹ä»¶</button>
        <button class="button" onclick="emitTestEvent()">è§¦å‘æµ‹è¯•äº‹ä»¶</button>
        <div id="eventResult" class="result"></div>
    </div>

    <div class="section">
        <h2>3. App èƒ½åŠ›</h2>
        <button class="button" onclick="appGetStatus()">è·å–çŠ¶æ€</button>
        <button class="button" onclick="appOpenSettings()">æ‰“å¼€ç³»ç»Ÿè®¾ç½®</button>
        <button class="button" onclick="appMinimize()">æœ€å°åŒ–</button>
        <button class="button" onclick="appExit()">é€€å‡º</button>
        <button class="button" onclick="appUpdateCheck()">æ£€æŸ¥æ›´æ–°</button>
        <button class="button" onclick="appUpdateApply()">æ‰§è¡Œæ›´æ–°</button>
        <div id="appResult" class="result"></div>
    </div>

    <div class="section">
        <h2>4. å¯¼èˆªæ§åˆ¶</h2>
        <button class="button" onclick="navOpen()">æ‰“å¼€é¡µé¢</button>
        <button class="button" onclick="navSetTitle()">è®¾ç½®æ ‡é¢˜</button>
        <button class="button" onclick="navSetBars()">è®¾ç½®å¯¼èˆªæ </button>
        <div id="navResult" class="result"></div>
    </div>

    <div class="section">
        <h2>5. UI ç»„ä»¶</h2>
        <button class="button" onclick="showToast()">æ˜¾ç¤º Toast</button>
        <button class="button" onclick="showAlert()">æ˜¾ç¤º Alert</button>
        <button class="button" onclick="showConfirm()">æ˜¾ç¤º Confirm</button>
        <button class="button" onclick="showActionSheet()">æ˜¾ç¤º ActionSheet</button>
        <button class="button" onclick="showLoading()">æ˜¾ç¤º Loading</button>
        <button class="button" onclick="doHaptics()">éœ‡åŠ¨åé¦ˆ</button>
        <button class="button" onclick="getSafeArea()">è·å–å®‰å…¨åŒºåŸŸ</button>
        <div id="uiResult" class="result"></div>
    </div>

    <div class="section">
        <h2>6. å­˜å‚¨åŠŸèƒ½</h2>
        <button class="button" onclick="setStorage()">è®¾ç½®å­˜å‚¨</button>
        <button class="button" onclick="getStorage()">è·å–å­˜å‚¨</button>
        <button class="button" onclick="removeStorage()">åˆ é™¤å­˜å‚¨</button>
        <button class="button" onclick="clearStorageApp()">æ¸…ç©ºå­˜å‚¨(app)</button>
        <button class="button" onclick="clearStorageWebview()">æ¸…ç©ºå­˜å‚¨(webview)</button>
        <div id="storageResult" class="result"></div>
    </div>

    <div class="section">
        <h2>7. æƒé™ç®¡ç†</h2>
        <button class="button" onclick="checkPermission()">æ£€æŸ¥ç›¸æœºæƒé™</button>
        <button class="button" onclick="requestPermission()">è¯·æ±‚ç›¸æœºæƒé™</button>
        <button class="button" onclick="ensurePermission()">ensureå¹¶æ‰§è¡Œ</button>
        <div id="permissionResult" class="result"></div>
    </div>

    <div class="section">
        <h2>8. è®¾å¤‡ä¿¡æ¯</h2>
        <button class="button" onclick="getDeviceIds()">è·å–è®¾å¤‡ID</button>
        <button class="button" onclick="getDeviceInfo()">è·å–è®¾å¤‡ä¿¡æ¯</button>
        <button class="button" onclick="getBatteryInfo()">è·å–ç”µæ± ä¿¡æ¯</button>
        <button class="button" onclick="getStorageInfo()">è·å–å­˜å‚¨ä¿¡æ¯</button>
        <button class="button" onclick="getMemoryInfo()">è·å–å†…å­˜ä¿¡æ¯</button>
        <button class="button" onclick="getCpuInfo()">è·å–CPUä¿¡æ¯</button>
        <div id="deviceResult" class="result"></div>
    </div>

    <div class="section">
        <h2>9. åˆ†äº« / å‰ªè´´æ¿</h2>
        <button class="button" onclick="shareContent()">åˆ†äº«å†…å®¹</button>
        <button class="button" onclick="copyLink()">å¤åˆ¶é“¾æ¥</button>
        <button class="button" onclick="clipboardSet()">å‰ªè´´æ¿å†™å…¥</button>
        <button class="button" onclick="clipboardGet()">å‰ªè´´æ¿è¯»å–</button>
        <div id="shareResult" class="result"></div>
    </div>

    <div class="section">
        <h2>10. é€šçŸ¥</h2>
        <button class="button" onclick="checkNotificationPermission()">æ£€æŸ¥é€šçŸ¥æƒé™</button>
        <button class="button" onclick="requestNotificationPermission()">è¯·æ±‚é€šçŸ¥æƒé™</button>
        <button class="button" onclick="showLocalNotification()">æ˜¾ç¤ºæœ¬åœ°é€šçŸ¥</button>
        <div id="notificationResult" class="result"></div>
    </div>

    <div class="section">
        <h2>11. è®¤è¯ / æ”¯ä»˜</h2>
        <button class="button" onclick="authGetToken()">è·å–Token</button>
        <button class="button" onclick="authRefreshToken()">åˆ·æ–°Token</button>
        <button class="button" onclick="paymentPay()">å‘èµ·æ”¯ä»˜(ç¤ºä¾‹)</button>
        <div id="authResult" class="result"></div>
    </div>

    <div class="section">
        <h2>12. ä¸‹è½½ / APK / ç¼“å­˜</h2>
        <button class="button" onclick="downloadStart()">å¼€å§‹ä¸‹è½½</button>
        <button class="button" onclick="downloadStatus()">ä¸‹è½½çŠ¶æ€</button>
        <button class="button" onclick="downloadPause()">æš‚åœä¸‹è½½</button>
        <button class="button" onclick="downloadResume()">æ¢å¤ä¸‹è½½</button>
        <button class="button" onclick="downloadCancel()">å–æ¶ˆä¸‹è½½</button>
        <button class="button" onclick="downloadList()">ä¸‹è½½ä»»åŠ¡åˆ—è¡¨</button>
        <button class="button" onclick="downloadM3u8()">ä¸‹è½½m3u8</button>
        <button class="button" onclick="downloadGetDefaultDir()">è·å–é»˜è®¤ä¸‹è½½ç›®å½•</button>
        <button class="button" onclick="downloadSetDefaultDir()">è®¾ç½®é»˜è®¤ä¸‹è½½ç›®å½•</button>
        <button class="button" onclick="downloadGetFilePath()">è·å–ä»»åŠ¡æ–‡ä»¶è·¯å¾„</button>
        <button class="button" onclick="apkDownload()">APKä¸‹è½½</button>
        <button class="button" onclick="apkInstall()">å®‰è£…APK</button>
        <button class="button" onclick="apkOpen()">æ‰“å¼€App</button>
        <button class="button" onclick="apkIsInstalled()">æ˜¯å¦å®‰è£…</button>
        <button class="button" onclick="cacheGetSize()">ç¼“å­˜å¤§å°</button>
        <button class="button" onclick="cacheClear()">æ¸…ç†ç¼“å­˜</button>

        <div id="apk-downloads-container"></div>
        <div id="m3u8-downloads-container"></div>

        <div id="downloadResult" class="result"></div>
        <div style="margin-top: 20px;">
            <h3>M3U8 æ’­æ”¾å™¨</h3>
            <video id="m3u8VideoPlayer"
                   class="video-js vjs-default-skin vjs-big-play-centered vjs-fluid" controls
                   preload="auto" data-setup="{}" autoplay muted></video>
        </div>
    </div>

    <div class="section">
        <h2>14. AppStore / TestFlight (iOS)</h2>
        <button class="button" onclick="appStoreOpen()">æ‰“å¼€AppStore</button>
        <button class="button" onclick="appStoreSearch()">AppStoreæœç´¢</button>
        <button class="button" onclick="testFlightOpen()">æ‰“å¼€TestFlighté‚€è¯·</button>
        <div id="iosResult" class="result"></div>
    </div>

    <div class="section">
        <h2>15. DeepLink</h2>
        <button class="button" onclick="deeplinkOpen()">æ‰“å¼€DeepLink</button>
        <button class="button" onclick="deeplinkParse()">è§£æDeepLink</button>
        <div id="deeplinkResult" class="result"></div>
    </div>

    <div class="section">
        <h2>16. LiveActivity</h2>
        <button class="button" onclick="liveStart()">å¼€å§‹å®å†µ</button>
        <button class="button" onclick="liveUpdate()">æ›´æ–°å®å†µ</button>
        <button class="button" onclick="liveStop()">åœæ­¢å®å†µ</button>
        <div id="liveResult" class="result"></div>
    </div>

    <div class="section">
        <h2>17. è§†é¢‘</h2>
        <button class="button" onclick="openVideo()">æ‰“å¼€è§†é¢‘</button>
        <div id="videoResult" class="result"></div>
    </div>

    <div class="section">
        <h2>18. å°è¯´</h2>
        <button class="button" onclick="openNovel()">æ‰“å¼€å°è¯´</button>
        <div id="novelResult" class="result"></div>
    </div>

    <div class="section">
        <h2>19. æ¼«ç”»</h2>
        <button class="button" onclick="openComic()">æ‰“å¼€æ¼«ç”»</button>
        <div id="comicResult" class="result"></div>
    </div>

    <div class="section">
        <h2>20. å¸–å­</h2>
        <button class="button" onclick="openPost()">æ‰“å¼€å¸–å­</button>
        <div id="postResult" class="result"></div>
    </div>

    <!-- <div class="section">
         <h2>21. ç›´æ’­</h2>
         <button class="button" onclick="startLive()">å¼€å§‹ç›´æ’­</button>
         <button class="button" onclick="stopLive()">åœæ­¢ç›´æ’­</button>
         <button class="button" onclick="playLive()">æ’­æ”¾ç›´æ’­</button>
         <button class="button" onclick="pauseLive()">æš‚åœç›´æ’­</button>
         <div id="liveResult" class="result"></div>
     </div>-->
</div>

<script>
        // MethodChannel listener for events from Flutter
        // if (window.flutter_inappwebview) {
        //     window.flutter_inappwebview.addEventListener('flutterInAppWebViewPlatformReady', function(event) {
        //         window.flutter_inappwebview.callHandler('com.example.appbridge_h5/webview_events', function(method, args) {
        //             if (method === 'dispatchEvent') {
        //                 const eventName = args.event;
        //                 const payload = args.payload;
        //                 window.dispatchEvent(new CustomEvent(eventName, { detail: payload }));
        //             }
        //         });
        //     });
        // }

        let eventUnsubscribe = null;

        function flutterIsReady() {
            console.log("flutterIsReady() called by Flutter. Starting SDK initialization.");
            initSDK();
        }

        async function initSDK() {
            console.log("initSDK: Function started.");
            const status = document.getElementById('status');

            // Utility function for promise timeouts
            function withTimeout(promise, ms, timeoutError = new Error('Promise timed out')) {
                let id;
                const timeout = new Promise((resolve, reject) => {
                    id = setTimeout(() => reject(timeoutError), ms);
                });
                return Promise.race([
                    promise.then((res) => { clearTimeout(id); return res; }),
                    timeout
                ]);
            }

            try {
                if (typeof AppBridge === 'undefined') {
                    console.error("initSDK: AppBridge SDK is undefined.");
                    throw new Error('AppBridge SDK æœªåŠ è½½');
                }

                console.log("initSDK: AppBridge is defined. Calling AppBridge.core.ready() with timeout.");
                await withTimeout(AppBridge.core.ready(), 5000, new Error('AppBridge.core.ready() timed out after 5 seconds.')); // 5-second timeout
                console.log("initSDK: AppBridge.core.ready() resolved. Calling AppBridge.core.getVersion() with timeout.");

                const versionResult = await withTimeout(AppBridge.core.getVersion(), 5000, new Error('AppBridge.core.getVersion() timed out after 5 seconds.')); // 5-second timeout
                console.log("initSDK: AppBridge.core.getVersion() resolved with:", versionResult);

                status.innerHTML = `
                    <div>âœ… SDK åˆå§‹åŒ–æˆåŠŸï¼</div>
                    <div>ç‰ˆæœ¬: ${versionResult.data?.bridgeVersion || 'æœªçŸ¥'}</div>
                `;
                status.className = 'status success';
                AppBridge.events.emit('ready', { timestamp: Date.now() });
                console.log("initSDK: AppBridge.events.emit(\'ready\') called. Initialization complete.");
            } catch (error) {
                console.error("AppBridgeH5 initialization failed:", error);
                status.innerHTML = `
                    <div>âŒ SDK åˆå§‹åŒ–å¤±è´¥</div>
                    <div>${error.msg || error.message || JSON.stringify(error)}</div>
                `;
                status.className = 'status error';
            }
        }
        // 2. äº‹ä»¶ç³»ç»Ÿ
        async function startEventListen() {
            const eventResultElement = document.getElementById('eventResult');
            try {
                const subscription = await AppBridge.events.on('ready', (data) => {
                    const result = document.getElementById('eventResult');
                    result.innerHTML += `æ”¶åˆ° ready äº‹ä»¶: ${JSON.stringify(data)}
`;
                });
                window.eventUnsubscribe = subscription;

                AppBridge.events.on('test', (data) => {
                    const result = document.getElementById('eventResult');
                    result.innerHTML += `æ”¶åˆ° test äº‹ä»¶: ${JSON.stringify(data)}
`;
                });
                eventResultElement.innerHTML += 'å¼€å§‹ç›‘å¬äº‹ä»¶...\n';
                eventResultElement.className = 'result success';
            } catch (error) {
                eventResultElement.innerHTML = `é”™è¯¯: ${error.msg || error.message || JSON.stringify(error)}`;
                eventResultElement.className = 'result error';
            }
        }

        function stopEventListen() {
            const result = document.getElementById('eventResult');
            try {
                if (window.eventUnsubscribe && typeof window.eventUnsubscribe.off === 'function') {
                    window.eventUnsubscribe.off();
                    window.eventUnsubscribe = null;
                }
                result.innerHTML += 'åœæ­¢ç›‘å¬äº‹ä»¶\n';
                result.className = 'result success';
            } catch (error) {
                result.innerHTML = `é”™è¯¯: ${error.msg || error.message || JSON.stringify(error)}`;
                result.className = 'result error';
            }
        }

        function emitTestEvent() {
            const result = document.getElementById('eventResult');
            try {
                AppBridge.events.emit('test', { message: 'Hello from test event!', timestamp: Date.now() });
                result.innerHTML += 'è§¦å‘æµ‹è¯•äº‹ä»¶\n';
                result.className = 'result success';
            } catch (error) {
                result.innerHTML = `é”™è¯¯: ${error.msg || error.message || JSON.stringify(error)}`;
                result.className = 'result error';
            }
        }

        // 1. æ ¸å¿ƒåŠŸèƒ½
        async function checkInit() {
            const result = document.getElementById('coreResult');
            try {
                const isReady = AppBridge.isReady ? AppBridge.isReady() : 'SDKå·²åŠ è½½';
                const readyResult = await AppBridge.core.ready();
                result.innerHTML = `åˆå§‹åŒ–çŠ¶æ€: ${isReady}\nReady ç»“æœ: ${JSON.stringify(readyResult, null, 2)}`;
                result.className = 'result success';
            } catch (error) {
                result.innerHTML = `é”™è¯¯: ${error.msg || error.message || JSON.stringify(error)}`;
                result.className = 'result error';
            }
        }

        async function getVersion() {
            const result = document.getElementById('coreResult');
            try {
                const versionResult = await AppBridge.core.getVersion();
                result.innerHTML = `ç‰ˆæœ¬ä¿¡æ¯:\n${JSON.stringify(versionResult, null, 2)}`;
                result.className = 'result success';
            } catch (error) {
                result.innerHTML = `é”™è¯¯: ${error.msg || error.message || JSON.stringify(error)}`;
                result.className = 'result error';
            }
        }

        async function getCapabilities() {
            const result = document.getElementById('coreResult');
            try {
                const capabilitiesResult = await AppBridge.core.getCapabilities();
                result.innerHTML = `å¯ç”¨åŠŸèƒ½:\n${JSON.stringify(capabilitiesResult, null, 2)}`;
                result.className = 'result success';
            } catch (error) {
                result.innerHTML = `é”™è¯¯: ${error.msg || error.message || JSON.stringify(error)}`;
                result.className = 'result error';
            }
        }

        async function getEnv() {
            const result = document.getElementById('coreResult');
            try {
                const envResult = await (AppBridge.core?.getEnv ? AppBridge.core.getEnv() : Promise.resolve({ code: 0, data: {}, msg: 'mock' }));
                result.innerHTML = `ç¯å¢ƒä¿¡æ¯:\n${JSON.stringify(envResult, null, 2)}`;
                result.className = 'result success';
            } catch (error) {
                result.innerHTML = `é”™è¯¯: ${error.msg || error.message || JSON.stringify(error)}`;
                result.className = 'result error';
            }
        }

        async function hasMethod() {
            const result = document.getElementById('coreResult');
            try {
                const r = await (AppBridge.core?.has ? AppBridge.core.has('device.getInfo') : { code: 0, data: true });
                result.innerHTML = `has('device.getInfo'): ${JSON.stringify(r, null, 2)}`;
                result.className = 'result success';
            } catch (error) {
                result.innerHTML = `é”™è¯¯: ${error.msg || error.message || JSON.stringify(error)}`;
                result.className = 'result error';
            }
        }

        async function vpnOn() {
            const result = document.getElementById('coreResult');
            try {
                const r = await (AppBridge.core?.setVpn ? AppBridge.core.setVpn({ on: true, config: { server: 'vpn.example.com', port: 443, protocol: 'IKEv2', username: 'user', password: '***' } }) : { code: 0, data: true });
                result.innerHTML = `VPN å¼€å¯: ${JSON.stringify(r, null, 2)}`;
                result.className = 'result success';
            } catch (e) { result.innerHTML = `é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; result.className = 'result error'; }
        }

        async function vpnOff() {
            const result = document.getElementById('coreResult');
            try {
                const r = await (AppBridge.core?.setVpn ? AppBridge.core.setVpn({ on: false }) : { code: 0, data: true });
                result.innerHTML = `VPN å…³é—­: ${JSON.stringify(r, null, 2)}`;
                result.className = 'result success';
            } catch (e) { result.innerHTML = `é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; result.className = 'result error'; }
        }

        async function addShortcut() {
            const result = document.getElementById('coreResult');
            try {
                const r = await (AppBridge.core?.addShortcuts ? AppBridge.core.addShortcuts({ title: 'Bridge Demo', url: location.href }) : { code: 0, data: true });
                result.innerHTML = `æ·»åŠ å¿«æ·æ–¹å¼: ${JSON.stringify(r, null, 2)}`;
                result.className = 'result success';
            } catch (e) { result.innerHTML = `é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; result.className = 'result error'; }
        }

        // 3. App èƒ½åŠ›
        async function appGetStatus() { const el=document.getElementById('appResult'); try{ const r=await (AppBridge.app?.getStatus?AppBridge.app.getStatus():{code:0,data:{}}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function appOpenSettings() { const el=document.getElementById('appResult'); try{ const r=await (AppBridge.app?.openSettings?AppBridge.app.openSettings('general'):{code:0,data:true}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function appMinimize() { const el=document.getElementById('appResult'); try{ const r=await (AppBridge.app?.minimize?AppBridge.app.minimize():{code:0,data:true}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function appExit() { const el=document.getElementById('appResult'); try{ const r=await (AppBridge.app?.exit?AppBridge.app.exit():{code:0,data:true}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function appUpdateCheck() { const el=document.getElementById('appResult'); try{ const r=await (AppBridge.app?.update?.check?AppBridge.app.update.check():{code:0,data:{hasUpdate:false}}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function appUpdateApply() { const el=document.getElementById('appResult'); try{ const r=await (AppBridge.app?.update?.apply?AppBridge.app.update.apply():{code:0,data:true}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }

        // 4. Nav
        async function navOpen(){
            console.log('>>> JS navOpen() called at ' + new Date().toISOString() + ' <<<'); // Add log
            const el=document.getElementById('navResult'); try{ const r=await (AppBridge.nav?.open?AppBridge.nav.open({ url:'packages/appbridge/assets/navigation_test.html', title:'å¯¼èˆªæ§åˆ¶'}):{code:0,data:true}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function navClose(){ const el=document.getElementById('navResult'); try{ const r=await (AppBridge.nav?.close?AppBridge.nav.close({ steps:1 }):{code:0,data:true}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function navReplace(){ const el=document.getElementById('navResult'); try{ const r=await (AppBridge.nav?.replace?AppBridge.nav.replace({ url:'https://developer.chrome.com/?hl=zh-cn' }):{code:0,data:true}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function navSetTitle(){ const el=document.getElementById('navResult'); try{ let titleToSet = ''; if (!isCustomTitleSet) { titleToSet = 'è®¾ç½®æ ‡é¢˜'; } else { titleToSet = 'JSæ’ä»¶Demo'; } const r=await (AppBridge.nav?.setTitle?AppBridge.nav.setTitle({ title:titleToSet, subtitle:'å‰¯æ ‡é¢˜' }):{code:0,data:true}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; isCustomTitleSet = !isCustomTitleSet; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function navSetBars(){ const el=document.getElementById('navResult'); try{ isNavBarsVisible = !isNavBarsVisible; const r=await (AppBridge.nav?.setBars?AppBridge.nav.setBars({ visible:isNavBarsVisible, color:'#ffffff', style:'dark' }):{code:0,data:true}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }

        // 5. UI åŠŸèƒ½
        async function showToast() {
            const result = document.getElementById('uiResult');
            try { const toastResult = await AppBridge.ui.toast({ text: 'Hello AppBridgeH5! ğŸ‰' }); result.innerHTML = `Toast ç»“æœ: ${JSON.stringify(toastResult, null, 2)}`; result.className = 'result success'; } catch (error) { result.innerHTML = `é”™è¯¯: ${error.msg || error.message || JSON.stringify(error)}`; result.className = 'result error'; }
        }
        async function showAlert() { const el=document.getElementById('uiResult'); try{ const r=await AppBridge.ui.alert({ title:'æç¤º', message:'è¿™æ˜¯ä¸€ä¸ªè­¦å‘Šå¼¹çª—' }); el.innerHTML=`Alert ç»“æœ: ${JSON.stringify(r,null,2)}`; el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function showConfirm() { const el=document.getElementById('uiResult'); try{ const r=await AppBridge.ui.confirm({ title:'ç¡®è®¤', message:'ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ' }); el.innerHTML=`Confirm ç»“æœ: ${JSON.stringify(r,null,2)}`; el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function showActionSheet() { const el=document.getElementById('uiResult'); try{ const r=await AppBridge.ui.actionSheet({ title:'é€‰æ‹©æ“ä½œ', items:[{id:'option1',text:'é€‰é¡¹ 1'},{id:'option2',text:'é€‰é¡¹ 2'}]}); el.innerHTML=`ActionSheet ç»“æœ: ${JSON.stringify(r,null,2)}`; el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function showLoading() { const el=document.getElementById('uiResult'); try{ const r=await AppBridge.ui.loading({ visible:true, text:'åŠ è½½ä¸­...' }); el.innerHTML=`Loading ç»“æœ: ${JSON.stringify(r,null,2)}`; el.className='result success'; setTimeout(async()=>{ await AppBridge.ui.loading({ visible:false }); },3000); }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function doHaptics() { const el=document.getElementById('uiResult'); try{ const r=await (AppBridge.ui?.haptics?AppBridge.ui.haptics({ style:'medium' }):{code:0,data:true}); el.innerHTML=`Haptics ç»“æœ: ${JSON.stringify(r,null,2)}`; el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function getSafeArea() { const el=document.getElementById('uiResult'); try{ const r=await (AppBridge.ui?.safeArea?AppBridge.ui.safeArea():{code:0,data:{ top:0,bottom:0,left:0,right:0 }}); el.innerHTML=`SafeArea: ${JSON.stringify(r,null,2)}`; el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }

        // 6. å­˜å‚¨
        async function setStorage() { const el=document.getElementById('storageResult'); try{ const r=await AppBridge.storage.set({ key:'demo_key', value:{ message:'Hello Storage!', timestamp:Date.now() }, ttlSec:3600 }); el.innerHTML=`è®¾ç½®å­˜å‚¨ç»“æœ: ${JSON.stringify(r,null,2)}`; el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function getStorage() { const el=document.getElementById('storageResult'); try{ const r=await AppBridge.storage.get({ key:'demo_key' }); el.innerHTML=`è·å–å­˜å‚¨ç»“æœ: ${JSON.stringify(r,null,2)}`; el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function removeStorage() { const el=document.getElementById('storageResult'); try{ const r=await AppBridge.storage.remove({ key:'demo_key' }); el.innerHTML=`åˆ é™¤å­˜å‚¨ç»“æœ: ${JSON.stringify(r,null,2)}`; el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function clearStorageApp() { const el=document.getElementById('storageResult'); try{ const r=await (AppBridge.storage?.clear?AppBridge.storage.clear({ scope:'app' }):{code:0,data:true}); el.innerHTML=`æ¸…ç©º(app)ç»“æœ: ${JSON.stringify(r,null,2)}`; el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function clearStorageWebview() { const el=document.getElementById('storageResult'); try{ const r=await (AppBridge.storage?.clear?AppBridge.storage.clear({ scope:'webview' }):{code:0,data:true}); el.innerHTML=`æ¸…ç©º(webview)ç»“æœ: ${JSON.stringify(r,null,2)}`; el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }

      // 7. æƒé™
        async function checkPermission() { const el=document.getElementById('permissionResult'); try{ const r=await AppBridge.permission.check({ name:'camera' }); el.innerHTML=`ç›¸æœºæƒé™çŠ¶æ€: ${JSON.stringify(r,null,2)}`; el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function requestPermission() { const el=document.getElementById('permissionResult'); try{ const r=await AppBridge.permission.request({ name:'camera' }); el.innerHTML=`è¯·æ±‚ç›¸æœºæƒé™ç»“æœ: ${JSON.stringify(r,null,2)}`; el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function ensurePermission() { const el=document.getElementById('permissionResult'); try{ const r=await (AppBridge.permission?.ensure?AppBridge.permission.ensure('camera', function(){ console.log('granted'); }):{code:0,data:true}); el.innerHTML=`ensure ç»“æœ: ${JSON.stringify(r,null,2)}`; el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }


        // 8. è®¾å¤‡
        async function getDeviceIds() { const el=document.getElementById('deviceResult'); try{ const r=await AppBridge.device.getIds(); el.innerHTML=`è®¾å¤‡ID:\n${JSON.stringify(r,null,2)}`; el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function getDeviceInfo() { const el=document.getElementById('deviceResult'); try{ const r=await AppBridge.device.getInfo(); el.innerHTML=`è®¾å¤‡ä¿¡æ¯:\n${JSON.stringify(r,null,2)}`; el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function getBatteryInfo() { const el=document.getElementById('deviceResult'); try{ const r=await AppBridge.device.getBattery(); el.innerHTML=`ç”µæ± ä¿¡æ¯:\n${JSON.stringify(r,null,2)}`; el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function getStorageInfo() { const el=document.getElementById('deviceResult'); try{ const r=await AppBridge.device.getStorageInfo(); el.innerHTML=`å­˜å‚¨ä¿¡æ¯:\n${JSON.stringify(r,null,2)}`; el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function getMemoryInfo() { const el=document.getElementById('deviceResult'); try{ const r=await (AppBridge.device?.getMemoryInfo?AppBridge.device.getMemoryInfo():{code:0,data:{}}); el.innerHTML=`å†…å­˜ä¿¡æ¯:\n${JSON.stringify(r,null,2)}`; el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function getCpuInfo() { const el=document.getElementById('deviceResult'); try{ const r=await (AppBridge.device?.getCpuInfo?AppBridge.device.getCpuInfo():{code:0,data:{}}); el.innerHTML=`CPUä¿¡æ¯:\n${JSON.stringify(r,null,2)}`; el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }

        // 9. åˆ†äº« / å‰ªè´´æ¿
        async function shareContent() { const el=document.getElementById('shareResult'); try{ const r=await AppBridge.share.open({ text:'åˆ†äº«æ ‡é¢˜', url:'https://google.com', image:'https://via.placeholder.com/300x200' }); el.innerHTML=`åˆ†äº«ç»“æœ: ${JSON.stringify(r,null,2)}`; el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function copyLink() { const el=document.getElementById('shareResult'); try{ const r=await (AppBridge.share?.copyLink?AppBridge.share.copyLink({ url:location.href }):{code:0,data:true}); el.innerHTML=`å¤åˆ¶é“¾æ¥ç»“æœ: ${JSON.stringify(r,null,2)}`; el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function clipboardSet() { const el=document.getElementById('shareResult'); try{ let r; if (AppBridge.clipboard?.set) r=await AppBridge.clipboard.set({ text:'è¿™æ˜¯è¦å¤åˆ¶çš„æ–‡æœ¬å†…å®¹' }); else if (navigator.clipboard){ await navigator.clipboard.writeText('è¿™æ˜¯è¦å¤åˆ¶çš„æ–‡æœ¬å†…å®¹'); r={code:0,data:true}; } else r={code:-1,msg:'clipboard not available'}; el.innerHTML=`å‰ªè´´æ¿å†™å…¥: ${JSON.stringify(r,null,2)}`; el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function clipboardGet() { const el=document.getElementById('shareResult'); try{ let r; if (AppBridge.clipboard?.get) r=await AppBridge.clipboard.get(); else if (navigator.clipboard){ const t=await navigator.clipboard.readText(); r={code:0,data:{text:t}}; } else r={code:-1,msg:'clipboard not available'}; el.innerHTML=`å‰ªè´´æ¿å†…å®¹: ${JSON.stringify(r,null,2)}`; el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }

        // 10. Notifications
        async function checkNotificationPermission() {
            const resultDiv = document.getElementById('notificationResult');
            try {
                const result = await window.AppBridge.permission.check({ name: 'notifications' });
                if (result.code === 0 && result.data === true) {
                    resultDiv.innerHTML = 'é€šçŸ¥æƒé™å·²ç»æˆäºˆã€‚';
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.innerHTML = 'é€šçŸ¥æƒé™å°šæœªæˆäºˆã€‚';
                    resultDiv.className = 'result warning';
                }
            } catch (error) {
                resultDiv.innerHTML = `æ£€æŸ¥æƒé™æ—¶å‘ç”Ÿé”™è¯¯: ${error.msg || error.message}`;
                resultDiv.className = 'result error';
            }
        }

        async function requestNotificationPermission() {
            const resultDiv = document.getElementById('notificationResult');
            try {
                const result = await window.AppBridge.permission.request({ name: 'notifications' });
                if (result.code === 0 && result.data === true) {
                    resultDiv.innerHTML = 'é€šçŸ¥æƒé™å·²æˆåŠŸè¯·æ±‚ã€‚';
                    resultDiv.className = 'result success';
                } else {
                    resultDiv.innerHTML = 'é€šçŸ¥æƒé™è¯·æ±‚è¢«æ‹’ç»ã€‚';
                    resultDiv.className = 'result error';
                }
            } catch (error) {
                resultDiv.innerHTML = `è¯·æ±‚æƒé™æ—¶å‘ç”Ÿé”™è¯¯: ${error.msg || error.message}`;
                resultDiv.className = 'result error';
            }
        }

        async function showLocalNotification() {

            const el = document.getElementById('notificationResult');
            try {
                const permissionResult = await AppBridge.notifications.checkPermission();
                if (permissionResult.data === true) {
                     // If permission is granted, show the notification
                    const notificationTitle = 'è¿™æ˜¯ä¸€ä¸ªæœ¬åœ°é€šçŸ¥';
                    const notificationBody = 'è¿™æ˜¯é€šçŸ¥çš„å†…å®¹ã€‚';
                    const showResult = await AppBridge.notifications.showLocal({
                        id: 'local_1',
                        title: notificationTitle,
                        body: notificationBody,
                        payload: {
                            customData: '123',
                            title: notificationTitle,
                            body: notificationBody,
                        }
                    });
                    el.innerHTML = `é€šçŸ¥æƒé™å·²æˆäºˆï¼Œæœ¬åœ°é€šçŸ¥ç»“æœ: ${JSON.stringify(showResult, null, 2)}`;
                    el.className = 'result success';
                } else {
                    el.innerHTML = `é€šçŸ¥æƒé™æœªæˆäºˆï¼Œè¯·åœ¨ç³»ç»Ÿè®¾ç½®ä¸­å¼€å¯ã€‚`;
                    el.className = 'result error';
                    // The Flutter side will open app settings if permission is not granted
                 }
             }
             catch (error) {
                el.innerHTML = `æ˜¾ç¤ºé€šçŸ¥æ—¶å‘ç”Ÿé”™è¯¯: ${error.msg || error.message}`;
                el.className = 'result error';
            }
        }

        window.addEventListener('notifications.click', (event) => {
            console.log('Received notifications.click event directly on window:', event.detail);
            const data = event.detail;
            const el = document.getElementById('notificationResult');
            const payload = data.payload;
            if (payload) {
                el.innerHTML = `ç”¨æˆ·ç‚¹äº†é€šçŸ¥ï¼šå†…å®¹: ${JSON.stringify(payload, null, 2)}`;
                el.className = 'result success';
            } else {
                el.innerHTML = `ç”¨æˆ·ç‚¹äº†é€šçŸ¥ï¼Œä½†æ²¡æœ‰è·å–åˆ°å†…å®¹ã€‚`;
                el.className = 'result warning';
            }
        });

        // 11. Auth / Payment
        async function authGetToken(){ const el=document.getElementById('authResult'); try{ const r=await (AppBridge.auth?.getToken?AppBridge.auth.getToken():{code:0,data:{token:'mock'}}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function authRefreshToken(){ const el=document.getElementById('authResult'); try{ const r=await (AppBridge.auth?.refreshToken?AppBridge.auth.refreshToken():{code:0,data:{token:'mock2'}}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function paymentPay(){ const el=document.getElementById('authResult'); try{ const r=await (AppBridge.payment?.pay?AppBridge.payment.pay({ productId:'prod_001', payType:'wxpay' }):{code:0,data:{status:'success'}}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }

        // 12. Download / APK / Cache
        async function downloadStart(){
            const el=document.getElementById('downloadResult');
            try{
                const url = 'https://apk.loapk.com/51dongman_android/yjdm_01_2.28.apk';
                const r = await (AppBridge.download?.start?AppBridge.download.start({ url: url }):{code:0,data:{id:'mock_id'}});
                if (r.code === 0 && r.data && r.data.id) {
                    const downloadId = r.data.id;
                    currentDownloadTaskId = downloadId;

                    // Create and append the new progress bar
                    const container = document.getElementById('apk-downloads-container');
                    const progressDiv = document.createElement('div');
                    progressDiv.id = `apk-progress-container-${downloadId}`;
                    progressDiv.className = 'result'; // Reuse some styling
                    progressDiv.innerHTML = `
                        <div><strong>APK ä¸‹è½½:</strong> ${url.substring(url.lastIndexOf('/') + 1)}</div>
                        <progress id="apk-progress-bar-${downloadId}" value="0" max="100" style="width: 100%;"></progress>
                        <div id="apk-progress-text-${downloadId}">0%</div>
                    `;
                    container.appendChild(progressDiv);
                }
                el.innerHTML=JSON.stringify(r,null,2);
                el.className='result success';
            }catch(e){
                el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`;
                el.className='result error';
            }
        }
        async function downloadStatus(){ const el=document.getElementById('downloadResult'); try{ if (!currentDownloadTaskId) { el.innerHTML=`é”™è¯¯: è¯·å…ˆå¼€å§‹ä¸‹è½½ä»»åŠ¡`; el.className='result error'; return; } const r=await (AppBridge.download?.status?AppBridge.download.status({ id:currentDownloadTaskId }):{code:0,data:{status:'mock'}}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function downloadPause(){ const el=document.getElementById('downloadResult'); try{ if (!currentDownloadTaskId) { el.innerHTML=`é”™è¯¯: è¯·å…ˆå¼€å§‹ä¸‹è½½ä»»åŠ¡`; el.className='result error'; return; } const r=await (AppBridge.download?.pause?AppBridge.download.pause({ id:currentDownloadTaskId }):{code:0,data:true}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function downloadResume(){ const el=document.getElementById('downloadResult'); try{ if (!currentDownloadTaskId) { el.innerHTML=`é”™è¯¯: è¯·å…ˆå¼€å§‹ä¸‹è½½ä»»åŠ¡`; el.className='result error'; return; } const r=await (AppBridge.download?.resume?AppBridge.download.resume({ id:currentDownloadTaskId }):{code:0,data:true}); if (r.code === 0 && r.data && r.data.id) { currentDownloadTaskId = r.data.id; } el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function downloadCancel(){ const el=document.getElementById('downloadResult'); try{ if (!currentDownloadTaskId) { el.innerHTML=`é”™è¯¯: è¯·å…ˆå¼€å§‹ä¸‹è½½ä»»åŠ¡`; el.className='result error'; return; } const r=await (AppBridge.download?.cancel?AppBridge.download.cancel({ id:currentDownloadTaskId }):{code:0,data:true}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function downloadList(){ const el=document.getElementById('downloadResult'); try{ const r=await (AppBridge.download?.list?AppBridge.download.list():{code:0,data:[]}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function downloadM3u8(){
            const el=document.getElementById('downloadResult');
            try{
                const m3u8Url = prompt("è¯·è¾“å…¥M3U8è§†é¢‘åœ°å€:", "https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8");
                if (!m3u8Url) {
                    el.innerHTML = 'ç”¨æˆ·å–æ¶ˆäº†è¾“å…¥ã€‚';
                    el.className = 'result';
                    return;
                }

                if (player) {
                    player.src({ type: 'application/x-mpegURL', src: m3u8Url });
                }

                const durationStr = prompt("è¯·è¾“å…¥è§†é¢‘æ€»æ—¶é•¿ï¼ˆç§’ï¼‰:", "634");
                const duration = parseInt(durationStr, 10) || 0;

                const confirmDownload = confirm(`ç¡®å®šè¦ä¸‹è½½å¹¶åˆå¹¶æ­¤M3U8è§†é¢‘å—ï¼Ÿ\nåœ°å€: ${m3u8Url}`);
                if (!confirmDownload) {
                    el.innerHTML = 'ç”¨æˆ·å–æ¶ˆäº†ä¸‹è½½ã€‚';
                    el.className = 'result';
                    return;
                }

                const downloadId = `m3u8-${Date.now()}`;

                // Create and append the new progress bar
                const container = document.getElementById('m3u8-downloads-container');
                const progressDiv = document.createElement('div');
                progressDiv.id = `m3u8-progress-container-${downloadId}`;
                progressDiv.className = 'result'; // Reuse some styling
                progressDiv.innerHTML = `
                    <div><strong>M3U8 ä¸‹è½½:</strong> ${m3u8Url.substring(m3u8Url.lastIndexOf('/') + 1)}</div>
                    <progress id="m3u8-progress-bar-${downloadId}" value="0" max="100" style="width: 100%;"></progress>
                    <div id="m3u8-progress-text-${downloadId}">0%</div>
                `;
                container.appendChild(progressDiv);

                el.innerHTML = 'å¼€å§‹ä¸‹è½½å’Œåˆå¹¶ M3U8...';
                el.className = 'result';

                // Initiate the download, but don't await its final result here
                AppBridge.download.m3u8({ id: downloadId, url: m3u8Url, duration: duration });

            } catch (e){
                el.innerHTML=`ä¸‹è½½m3u8é”™è¯¯ä¿¡æ¯: ${e.msg || e.message || JSON.stringify(e)}`;
                el.className='result error';
            }
        }
        async function downloadGetDefaultDir(){ const el=document.getElementById('downloadResult'); try{ const r=await (AppBridge.download?.getDefaultDir?AppBridge.download.getDefaultDir():{code:0,data:'/download'}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function downloadSetDefaultDir(){ const el=document.getElementById('downloadResult'); try{ const r=await (AppBridge.download?.setDefaultDir?AppBridge.download.setDefaultDir({ path:'/storage/emulated/0/Download' }):{code:0,data:true}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function downloadGetFilePath(){ const el=document.getElementById('downloadResult'); try{ if (!currentDownloadTaskId) { el.innerHTML=`é”™è¯¯: è¯·å…ˆå¼€å§‹ä¸‹è½½ä»»åŠ¡`; el.className='result error'; return; } const r=await (AppBridge.download?.getFilePath?AppBridge.download.getFilePath({ id:currentDownloadTaskId }):{code:0,data:'/storage/emulated/0/Download/file'}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }

        async function apkDownload(){
            const el=document.getElementById('downloadResult');
            try{
                const url = 'https://apk.loapk.com/51dongman_android/yjdm_01_2.28.apk';
                const r = await (AppBridge.apk?.download?AppBridge.apk.download({ url: url, id:'yjdm_01_2' }):{code:0,data:true});
                if (r.code === 0 && r.data && r.data.id) {
                    const downloadId = r.data.id; // Use the ID returned by the native call
                    lastDownloadedApkPath = r.data.path;

                    // Create and append the new progress bar
                    const container = document.getElementById('apk-downloads-container');
                    const progressDiv = document.createElement('div');
                    progressDiv.id = `apk-progress-container-${downloadId}`;
                    progressDiv.className = 'result'; // Reuse some styling
                    progressDiv.innerHTML = `
                        <div><strong>APK ä¸‹è½½:</strong> ${url.substring(url.lastIndexOf('/') + 1)}</div>
                        <progress id="apk-progress-bar-${downloadId}" value="0" max="100" style="width: 100%;"></progress>
                        <div id="apk-progress-text-${downloadId}">0%</div>
                    `;
                    container.appendChild(progressDiv);
                }
                el.innerHTML=JSON.stringify(r,null,2);
                el.className='result success';
            }catch(e){
                el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`;
                el.className='result error';
            }
        }
        async function apkInstall(){ const el=document.getElementById('downloadResult'); try{ if (!lastDownloadedApkPath) { el.innerHTML=`é”™è¯¯: è¯·å…ˆä¸‹è½½APKæ–‡ä»¶`; el.className='result error'; return; } const r=await (AppBridge.apk?.install?AppBridge.apk.install({ path:lastDownloadedApkPath }):{code:0,data:true}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function apkOpen(){ const el=document.getElementById('downloadResult'); try{ const r=await (AppBridge.apk?.open?AppBridge.apk.open({ packageName:'com.google.android.apps.maps' }):{code:0,data:true}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function apkIsInstalled(){ const el=document.getElementById('downloadResult'); try{ const r=await (AppBridge.apk?.isInstalled?AppBridge.apk.isInstalled({ packageName:'com.google.android.apps.maps' }):{code:0,data:false}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }

        async function cacheGetSize(){ const el=document.getElementById('downloadResult'); try{ const r=await (AppBridge.cache?.getSize?AppBridge.cache.getSize():{code:0,data:{size:0,unit:'bytes'}}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function cacheClear(){ const el=document.getElementById('downloadResult'); try{ const r=await (AppBridge.cache?.clear?AppBridge.cache.clear({ type:'all' }):{code:0,data:true}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }

        // 14. AppStore / TestFlight
        async function appStoreOpen(){ const el=document.getElementById('iosResult'); try{ const r=await (AppBridge.appstore?.open?AppBridge.appstore.open({ appId:'414478124' }):{code:0,data:true}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function appStoreSearch(){ const el=document.getElementById('iosResult'); try{ const r=await (AppBridge.appstore?.search?AppBridge.appstore.search({ keyword:'WeChat' }):{code:0,data:true}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function testFlightOpen(){ const el=document.getElementById('iosResult'); try{ const r=await (AppBridge.testflight?.open?AppBridge.testflight.open({ inviteUrl:'https://testflight.apple.com/join/xxxx' }):{code:0,data:true}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }

        // 15. DeepLink
        async function deeplinkOpen(){ const el=document.getElementById('deeplinkResult'); try{ const r=await (AppBridge.deeplink?.open?AppBridge.deeplink.open({ url:'https://www.google.com' }):{code:0,data:true}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function deeplinkParse(){ const el=document.getElementById('deeplinkResult'); try{ const r=await (AppBridge.deeplink?.parse?AppBridge.deeplink.parse({ url:'googlechrome://navigate?url=https://developer.chrome.com/?hl=zh-cn' }):{code:0,data:{}}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }

        // 16. LiveActivity
        async function liveStart(){ const el=document.getElementById('liveResult'); try{ const r=await (AppBridge.liveActivity?.start?AppBridge.liveActivity.start({ id:'live_1', title:'è¿›åº¦', progress:0.1 }):{code:0,data:true}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function liveUpdate(){ const el=document.getElementById('liveResult'); try{ const r=await (AppBridge.liveActivity?.update?AppBridge.liveActivity.update({ id:'live_1', title:'è¿›åº¦', progress:0.5 }):{code:0,data:true}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function liveStop(){ const el=document.getElementById('liveResult'); try{ const r=await (AppBridge.liveActivity?.stop?AppBridge.liveActivity.stop({ id:'live_1' }):{code:0,data:true}); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }

        async function openComic(){ const el=document.getElementById('comicResult'); try{ const r=await AppBridge.comics.open({ id:'comic_123', title:'æ¼”ç¤ºæ¼«ç”»', url:'https://google.com' }); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function openNovel(){ const el=document.getElementById('novelResult'); try{ const r=await AppBridge.novel.open({ id:'novel_456', title:'æ¼”ç¤ºå°è¯´', url:'https://google.com' }); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function openVideo(){ const el=document.getElementById('videoResult'); try{ const r=await AppBridge.video.open({ id:'video_789', title:'æ¼”ç¤ºè§†é¢‘æ’­æ”¾', url:'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8' }); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function openPost(){ const el=document.getElementById('postResult'); try{ const r=await AppBridge.post.open({ id:'post_012', title:'æ¼”ç¤ºå¸–å­', url:'https://google.com' }); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }

        async function startLive(){ const el=document.getElementById('liveResult'); try{ const r=await AppBridge.live.start({ id:'live_stream_1', title:'æ¼”ç¤ºç›´æ’­' }); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function stopLive(){ const el=document.getElementById('liveResult'); try{ const r=await AppBridge.live.stop({ id:'live_stream_1' }); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function playLive(){ const el=document.getElementById('liveResult'); try{ const r=await AppBridge.live.play({ id:'live_stream_1' }); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }
        async function pauseLive(){ const el=document.getElementById('liveResult'); try{ const r=await AppBridge.live.pause({ id:'live_stream_1' }); el.innerHTML=JSON.stringify(r,null,2); el.className='result success'; }catch(e){ el.innerHTML=`é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`; el.className='result error'; } }

        async function switchAppIcon() {
            const result = document.getElementById('coreResult');
            try {
                const r = await (AppBridge.core?.appIcon ? AppBridge.core.appIcon({ styleId: 'festival' }) : { code: 0, data: true });
                result.innerHTML = `åˆ‡æ¢å›¾æ ‡: ${JSON.stringify(r, null, 2)}`;
                result.className = 'result success';
            } catch (e) {
                result.innerHTML = `é”™è¯¯: ${e.msg || e.message || JSON.stringify(e)}`;
                result.className = 'result error';
            }
        }




</script>
</body>
</html>